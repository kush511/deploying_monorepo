name : Continous deployment ( backend )
on: 
  push:
    branches: [ main ]
jobs: 
  deploy: 
    runs-on : ubuntu-latest
    steps:
     - name: checkout the code
       uses: actions/checkout@v4
    
     - name: Docker login
       uses: docker/login-action@v3
       with: 
        username : ${{secrets.DOCKER_USERNAME}}
        password : ${{secrets.DOCKER_PASSWORD}}

     - name : Build and push the image
       uses : docker/build-push-action@v4
       with: 
        context: .
        file : docker/Dockerfile.backend
        push : true
        tags: kush511/deploy-monorepo-backend:${{github.sha}}

     - name: Execute remote SSH commands using SSH key
       uses: appleboy/ssh-action@v1
       with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          port: ${{ secrets.PORT }}
          script: |
            docker pull kush511/deploy-monorepo-backend:${{github.sha}}
            docker stop prod_backend || true
            docker rm prod_backend || true
            docker run -d \
            --name prod_backend \
            -e DATABASE_URL=${{secrets.DATABASE_URL}}
            -p 8080:8080 \
            kush511/deploy-monorepo-backend:${{github.sha}}


